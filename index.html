<style>
    #chart-container {
        width: 100%;
        max-width: 600px; /* Adjust as needed */
        height: 300px; /* Fixed height for better visibility */
        margin: auto; /* Centers the chart */
    }
</style>

<div id="chart-container">
    <canvas id="severityChart"></canvas>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetch('compliance-report.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to load compliance-report.json");
                }
                return response.json();
            })
            .then(data => {
                let tableBody = document.getElementById('compliance-data');
                let lastUpdated = document.getElementById('last-updated');
                let severityCounts = { "Critical": 0, "High": 0, "Medium": 0, "Low": 0, "Informational": 0 };

                tableBody.innerHTML = "";
                data.findings.forEach(finding => {
                    let severityClass = finding.severity.toLowerCase().replace(" ", "-");
                    severityCounts[finding.severity]++;

                    let row = `<tr>
                        <td>${finding.title}</td>
                        <td class="${severityClass}">${finding.severity}</td>
                        <td>${finding.service}</td>
                        <td>
                            ${finding.compliance_standard}
                            <span class="tooltip">${finding.full_compliance_standards}</span>
                        </td>
                        <td>${finding.remediation_time}</td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });

                lastUpdated.textContent = new Date().toLocaleString();

                // **Fix Chart.js size to prevent it from becoming too large**
                let ctx = document.getElementById('severityChart').getContext('2d');
                if (window.severityChart) window.severityChart.destroy(); // Destroy existing chart before creating a new one
                
                window.severityChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(severityCounts),
                        datasets: [{
                            label: 'Findings Count',
                            data: Object.values(severityCounts),
                            backgroundColor: ['#990000', '#ff4d4d', '#ffcc00', '#4CAF50', '#bbb']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error("Error loading compliance-report.json:", error);
                document.getElementById("compliance-data").innerHTML = "<tr><td colspan='5'>Error loading data.</td></tr>";
            });
    });
</script>
